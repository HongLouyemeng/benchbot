#!/usr/bin/env bash

################################################################################
########################## Settings & Pre-run Actions ##########################
################################################################################

IMAGE_REFERENCE="benchbot/simulator:devel"
NETWORK_NAME="benchbot_network"
ENV_FILENAME=".benchbot_data.yaml"

# Start in root of benchbot_devel & ensure helpers exist
pushd $(dirname $0) >/dev/null
# TODO guarantee helpers submodule is initialised ...
source .helpers/bash

################################################################################
######################## Helper functions for commands #########################
################################################################################

usage_text="$(basename "$0") -- Run script for the BenchBot backend & simulator

USAGE:

    Get info about the program / available options:
        $(basename "$0") [-h|--help|--list-tasks|--list-envs]

    Run a simulator with a specifc task setup:
        $(basename "$0") --env ENV_NAME --task TASK_NAME
        $(basename "$0") -e ENV_NAME -t TASK_NAME

OPTION DETAILS:

    -h,--help             
            Show this help menu.

    --list-envs
            Search for & list all installed environments. The listed
            environment names are in the format needed for the --env option.

    --list-tasks   
            Lists all supported task combinations. The listed tasks are printed
            in the formant needed for the --task option.

    -e, --env             
            Select an environment to launch in the simulator (this must be
            called with the --task option). Environments are identified via
            \"ENVIRONMENT_NAME:VARIATION_NUMBER\" where ENVIRONMENT_NAME is the
            name of simulated environment & VARIATION_NUMBER environment
            variation to use. For example, the third variation of the office
            environment would be: 

                    office:3

            (Use --list-envs to see a list of available environments)

    -t, --task             
            Configure BenchBot for a specific task style (this must be called
            with the --env option). A task is specified through the format
            \"TYPE:CONTROL_MODE:LOCALISATION_MODE\" where TYPE is the type of
            task, CONTROL_MODE is the control options available on the robot, &
            LOCALISATION_MODE is the accuracy of localisation feedback
            received. For example, a robot with passive control & ground truth
            localisation completing semantic SLAM would be:

                    semantic_slam:passive:ground_truth

            (Use --list-tasks to see a list of supported task options)

FURTHER DETAILS:
    
    Please contact the authors of BenchBot for support or to report bugs:
        b.talbot@qut.edu.au
    "

SELECTED_ENV=
SELECTED_TASK=

_task_list=("semantic_slam:passive:ground_truth"
  "semantic_slam:active:ground_truth"
  "semantic_slam:active:dead_reckoning"
  "scd:passive:ground_truth"
  "scd:active:ground_truth"
  "scd:active:dead_reckoning"
)

_env_data() {
  # This is a little gross... sorry.
  docker run -t $IMAGE_REFERENCE /bin/bash -c \
    'find $ISAAC_SIM_PATH/IsaacSimProject/Content -name "'"$ENV_FILENAME"'"\
    | while read env; do echo "$(dirname $env)"; cat $env; done'
}

opt_list_envs() {
  # TODO check if installed (docker image exists); provide a message if not
  # telling them how to fix the issue

  # Get the environment data, & pull out useful information
  env_data=$(_env_data)
  envs=$(echo "$env_data" | grep "environment_name:" | \
    sed 's/.*: "\?\([0-9A-Za-z]*\)_\([0-9]*\)"\?/\1:\2/' | sort)

  # Print the list with details
  echo "The following environments are installed in your BenchBot Docker image:
  "
  for e in $envs; do
    echo "        $e"
  done
  echo "
The string is of the format ENV_NAME:VARIATION_NUMBER. Note when running the
semantic change detection tasks you will have to specifiy a second variation
using the format ENV_NAME:VARIATION_NUMBER_ONE:VARIATION_NUMBER_TWO.
  "
}

opt_list_tasks() {
  # TODO this is hard coded for now... maybe should be done differently...
  echo "The following tasks are supported by BenchBot: 
  "
  for t in "${_task_list[@]}"; do
    echo "        $t"
  done
  echo "
The string is of the format TYPE:CONTROL_MODE:LOCALISATION_MODE.

TYPE DETAILS:
        semantic_slam:
            TODO 

        scd:
            TODO (semantic change detection)

CONTROL_MODE DETAILS:
        passive_mode:
            TODO

        active_mode:
            TODO
      
LOCALISATION_MODE DETAILS:
        ground_truth:
            TODO

        dead_reckoning:
            TODO
  "
}

opt_select_env() {
  echo "Selecting environment... $1"
}

opt_select_task() {
  echo "Selecting task.. $1"
}


################################################################################
#################### Parse & handle command line arguments #####################
################################################################################

# Safely parse options input
parse_out=$(getopt -o he:t: --long help,env:,task:,list-envs,list-tasks \
  -n 'run' -- "$@")
if [ $? != 0 ]; then exit 1; fi
eval set -- "$parse_out"
while true; do
  case "$1" in
    -h|--help)
      echo "$usage_text" ; shift ; exit 0 ;;
    --list-envs)
      opt_list_envs ; shift ; exit 0 ;;
    --list-tasks)
      opt_list_tasks ; shift ; exit 0 ;;
    -e|--env)
      opt_select_env "$2"; shift 2 ;;
    -t|--task)
      opt_select_task "$2"; shift 2 ;;
    --)
      shift ; break ;;
    *)
      echo "run: option '$1' is unknown"; shift ; exit 1 ;;
  esac
done

# Bail if we are running & they didn't give us both an environment & task
if [ -z "$SELECTED_ENV" ]; then 
  echo "ERROR: No valid environment selected (selected_env="$SELECTED_ENV")"
  exit 1
fi
if [ -z "$SELECTED_TASK" ]; then 
  echo "ERROR: No valid task selected (selected_task="$SELECTED_TASK")"
  exit 1
fi

echo "Running..."
exit 0

################################################################################
##################### Run the simulator & BenchBot backend #####################
################################################################################

# Clean up before we start, & create the network
echo "Cleaning up any Docker containers still lying around ..."
if [ $(docker ps -a -q | wc -l) -gt 0 ]; then
  docker stop $(docker ps -a -q)
fi
docker system prune -f
echo -e "Cleaned!\n"
docker network create "$NETWORK_NAME"
echo -e "Created $NETWORK_NAME.\n"

# Create reusable parts to ensure our containers run with consistent settings
ros_master_host="roscore"
docker_run="docker run -t --rm --gpus all -v /tmp/.X11-unix:/tmp/.X11-unix \
            -e DISPLAY \
            -e ROS_MASTER_URI=http://$ros_master_host:11311 -e ROS_HOSTNAME=\$name \
            --network $NETWORK_NAME --name=\$name --hostname=\$name"
cmd_prefix='source $ROS_WS_PATH/devel/setup.bash && '

# Start containers for ROS, isaac_simulator, benchbot_simulator, & benchbot_supervisor
name="$ros_master_host"
${docker_run//'$name'/$name} -d benchbot/simulator:devel /bin/bash -c \
  "$cmd_prefix"'roscore'

name="simulator"
${docker_run//'$name'/$name} -d benchbot/simulator:devel /bin/bash -c \
  "$cmd_prefix"'cd $BENCHBOT_SIMULATOR_PATH && ./bazelros run //apps/benchbot_simulator & \
  cd $ISAAC_SIM_PATH && ./Engine/Binaries/Linux/UE4Editor IsaacSimProject \
  /Game/AIUE_V01_003_day/Maps/AIUE_V01_003 \
  -isaac_sim_config_json="$ISAAC_SDK_PATH/apps/carter/carter_sim/bridge_config/carter_full.json" \
  -game -windowed -ResX=1024 -RexY=720 -vulkan' # NOTE: these have been collapsed into the one 
                                                # container as Isaac seems to have no useful
                                                # tools for linking between separate hosts except
                                                # for manually creating a *.json for every TcpPublisher
                                                # in your system to change the target (not sure how
                                                # this would even work if I had a topic with listeners
                                                # on both computers A & B...). Combine that with no 
                                                # useful tools for listing what topics currently exist 
                                                # (e.g. 'rostopic list'), and the task of manually 
                                                # going through 1 by 1 & specifying what should point
                                                # where... is a no from me.

name="debug"
${docker_run//'$name'/$name} -i benchbot/simulator:devel

################################################################################
####################### Messages suggesting how to view  #######################
################################################################################

# TODO
